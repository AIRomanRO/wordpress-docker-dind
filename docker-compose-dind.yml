version: '3.8'

services:
  wordpress-dind:
    image: airoman/wp-dind:${DIND_IMAGE_TAG:-dind-27.0.3}
    container_name: ${DIND_CONTAINER_NAME:-wordpress-dind-host}
    privileged: true
    env_file:
      - .env
    environment:
      - DOCKER_TLS_CERTDIR=
      - ENABLE_NETWORK_ISOLATION=true
      # Pass DinD configuration to container
      - DEFAULT_MYSQL_VERSION=${DEFAULT_MYSQL_VERSION:-80}
      - DEFAULT_PHP_VERSION=${DEFAULT_PHP_VERSION:-83}
      - DEFAULT_WEBSERVER=${DEFAULT_WEBSERVER:-nginx}
      - DEFAULT_DB_NAME=${DEFAULT_DB_NAME:-wordpress}
      - DEFAULT_DB_USER=${DEFAULT_DB_USER:-wordpress}
      # Pass WordPress defaults to container
      - WORDPRESS_WEBSITE_TITLE=${WORDPRESS_WEBSITE_TITLE:-My WordPress Site}
      - WORDPRESS_ADMIN_USER=${WORDPRESS_ADMIN_USER:-admin}
      - WORDPRESS_ADMIN_PASSWORD=${WORDPRESS_ADMIN_PASSWORD:-change-this-password}
      - WORDPRESS_ADMIN_EMAIL=${WORDPRESS_ADMIN_EMAIL:-admin@example.com}
      - WORDPRESS_LOCALE=${WORDPRESS_LOCALE:-en_US}
    ports:
      - "${DOCKER_DAEMON_PORT:-2375}:2375"                                                    # Docker daemon
      - "${WP_INSTANCE_PORT_RANGE_START:-8000}-${WP_INSTANCE_PORT_RANGE_END:-8099}:8000-8099" # WordPress instances
      - "${PHPMYADMIN_PORT:-8080}:8080"                                                       # phpMyAdmin (inside DinD)
      - "${MAIL_CATCHER_HTTP_PORT:-1080}:1080"                                                # MailCatcher Web UI (inside DinD)
      - "${MAIL_CATCHER_SMTP_PORT:-1025}:1025"                                                # MailCatcher SMTP (inside DinD)
      - "${REDIS_PORT:-6379}:6379"                                                            # Redis cache server (inside DinD)
      - "${REDIS_COMMANDER_PORT:-8082}:8081"                                                  # Redis Commander Web UI (inside DinD)
    volumes:
      - wordpress-instances:/wordpress-instances
      - dind-docker-data:/var/lib/docker
      - ./shared-images:/shared-images
      - ./config:/host-config:ro           # Mount host config folder (read-only)
      - ./logs:/host-logs                  # Mount host logs folder (read-write)
    networks:
      - wp-dind
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "docker", "info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  wp-dind:
    name: wp-dind
    driver: bridge
    ipam:
      config:
        - subnet: ${DIND_NETWORK_SUBNET:-172.19.0.0/16}

volumes:
  wordpress-instances:
    driver: local
  dind-docker-data:
    driver: local
